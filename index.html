<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
  	<script src="https://telegram.org/js/telegram-web-app.js"></script>
  	<title>SkinCare –ö–∞–º–µ—Ä–∞</title>
  	<style>
    	body {
      		margin: 0;
			background: #000;
	      	display: flex;
		    flex-direction: column;
		    align-items: center;
		    justify-content: center;
		    height: 100vh;
		    color: white;
		    font-family: sans-serif;
		}

    	#loading-screen {
		    position: fixed;
		    top: 0;
		    left: 0;
		    width: 100vw;
		    height: 100vh;
		    background: black;
		    z-index: 9999;
			display: flex;
		    flex-direction: column;
		    align-items: center;
		    justify-content: center;
			font-size: 45px;
    	}

    	#video {
     		display:block;
		    margin-left:auto;
		    margin-right:auto;
		    width:100vw;
		    height: 80vh;
		    object-fit: cover;
		    top: -10px;
		    left: 0;
		    z-index: 1;
			transform: scaleX(-1);
    	}

    	#overlay {
			position: absolute;
		    margin-left:auto;
		    margin-right:auto;
		    top: 0;
		    left: 0;
		    width: 100vw;
		    height: 80vh;
		    z-index: 2;
		    pointer-events: none;
   		}
		
    	#snap {
	     	position: absolute;
		    bottom: 40px;
		    left: 50%;
		    transform: translateX(-50%);
		    z-index: 3;
		    padding: 40px 80px;
		    font-size: 35px;
		    background-color: #ff69b4;
		    border: none;
		    border-radius: 12px;
		    color: white;
		    cursor: pointer;
		}

    	canvas {
      		display: none;
    	}
		#error-message {
		    display: none;
		    color: red;
		    text-align: center;
		    padding: 20px;
    	}
	</style>
</head>
<body>
	<div id="loading-screen">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä—ã...</div>
	<div id="error-message"></div>
		
	<div style="position: relative;">
		<video id="video" autoplay playsinline></video>
		<img id="overlay" src="oval-mask.png" alt="–ú–∞—Å–∫–∞ –æ–≤–∞–ª–∞">
	</div>
	
	<button id="snap">üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
	<canvas id="canvas"></canvas>
		
 	<script>
		const video = document.getElementById('video');
		const canvas = document.getElementById('canvas');
		const snapBtn = document.getElementById('snap');
		const loadingScreen = document.getElementById('loading-screen');
		const errorMessage = document.getElementById('error-message');
		let tg = window.Telegram.WebApp;
		let cameraReady = false;
		
// üîë –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –ö–õ–Æ–ß –° IMGBB.COM
		const IMGBB_API_KEY = '9b14893d3a17360887a960319353f0b2';
		
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Telegram WebApp
		if (window.Telegram && Telegram.WebApp) {
			tg.ready();
			tg.expand();
		} else {
			alert("Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ Telegram.");
		}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–æ–∫
	    function showError(message) {
			errorMessage.textContent = message;
	        errorMessage.style.display = 'block';
	        loadingScreen.style.display = 'none';
	        console.error(message);
	    }
	 
  // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
		async function startCamera() {
			try {
		// –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
				const stream = await navigator.mediaDevices.getUserMedia({ 
					video: { 
		            	facingMode: 'user', // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É
			            width: { ideal: 1280 },
			            height: { ideal: 720 }
					}
				});
				video.srcObject = stream;
				video.addEventListener('loadeddata', () => {
					cameraReady = true;
		        	loadingScreen.style.display = 'none';
		    	});
    		} catch (err) {
				alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.');
      			console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
    		}
  		}
  

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∏–º–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
		function captureFullSizePhoto() {
			if (!cameraReady) {
				alert("‚è≥ –ö–∞–º–µ—Ä–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞. –ü–æ–¥–æ–∂–¥–∏ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.");
          		return null;
      		}
			
// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas —Ä–∞–≤–Ω—ã–º —Ä–µ–∞–ª—å–Ω–æ–º—É —Ä–∞–∑–º–µ—Ä—É –≤–∏–¥–µ–æ
		  	canvas.width = video.videoWidth;
		  	canvas.height = video.videoHeight;
		  	const ctx = canvas.getContext('2d');
			
// –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –Ω–∞ canvas —Å –∑–µ—Ä–∫–∞–ª—å–Ω—ã–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
	      	ctx.save();
			ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
	      	ctx.restore();
			
// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º
      		return canvas.toDataURL('image/jpeg', 1.0);
		}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ–æ—Ç–æ –≤ IMGBB
		async function uploadToImgBB(imageData) {
			try {
				// –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å data:image/jpeg;base64,
				const base64Data = imageData.split(',')[1];
				
				// –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
				const formData = new FormData();
				formData.append('image', base64Data);
				
				// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ ImgBB
				const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
					method: 'POST',
					body: formData
				});
				if (!response.ok) {
					throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);
				}
				
				const result = await response.json();
				
				if (result.success) {
					return result.data.url; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º URL —Ñ–æ—Ç–æ
				} else {
					throw new Error('ImgBB –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É');
					alert('ImgBB –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É');
				}
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ ImgBB:', error);
				alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ ImgBB:');
				throw error;
			}
		}
		
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫"
		snapBtn.addEventListener('click', async () => {
			if (!cameraReady) {
        		alert("‚è≥ –ö–∞–º–µ—Ä–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞. –ü–æ–¥–æ–∂–¥–∏ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.");
        		return;
      		}
			
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
	    snapBtn.disabled = true;
	    snapBtn.textContent = "üì∏ –û–±—Ä–∞–±–æ—Ç–∫–∞...";
		try {
			const imageData = captureFullSizePhoto();
			video.srcObject.getTracks().forEach(track => track.stop());
			video.style.display = 'none'; // —Å–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ

			// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º canvas
			canvas.style.display = 'block';
			document.getElementById('overlay').style.display = 'none';
			canvas.style.width = '100vw';
			canvas.style.height = '80vh';
			canvas.style.objectFit = 'cover';
			canvas.style.transform = 'scaleX(-1)';
			
            if (!imageData) {
				alert('—Ñ–æ—Ç–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç')
        		return;
        	}
			snapBtn.textContent = "üì∏ –ó–∞–≥—Ä—É–∂–∞–µ–º...";
			const photoUrl = await uploadToImgBB(imageData);
			console.log("initDataUnsafe:", Telegram.WebApp.initDataUnsafe);
			console.log("user:", Telegram.WebApp.initDataUnsafe.user);


  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram –±–æ—Ç
        	if (window.Telegram && Telegram.WebApp) {
				
    // –î–ª—è –±–æ–ª—å—à–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ–º showConfirm –∏ sendData
				Telegram.WebApp.sendData(JSON.stringify({
	            	action: 'skin_analysis_photo',
					userid: Telegram.WebApp.initDataUnsafe.user?.id,
					username: Telegram.WebApp.initDataUnsafe.user?.username,
					//photo_base24:imageData,
		            photo_url: photoUrl, // ‚úÖ –û–¢–ü–†–ê–í–õ–Ø–ï–ú –°–°–´–õ–ö–£, –ê –ù–ï –§–û–¢–û
		            width: canvas.width,
		            height: canvas.height,
		            timestamp: new Date().toISOString()// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
	          	}));
				
// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–Ω–µ —Å—Ä–∞–∑—É –∑–∞–∫—Ä—ã–≤–∞–µ–º)
	            setTimeout(() => Telegram.WebApp.close(), 500);
        	} else {
          		alert("‚ö†Ô∏è Telegram WebApp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
        	}
      	} catch (error) {
			console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–æ—Ç–æ:', error);
        	alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–æ—Ç–æ', error);
			
      	} finally {
			
// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        	snapBtn.disabled = false;
        	snapBtn.textContent = "üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫";
		}
	});

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    startCamera();
	</script>

</body>
</html>


























